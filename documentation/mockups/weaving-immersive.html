<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dagger-App — Weaving (Immersive Mockup)</title>

  <!--
    ==========================================================================
    STAGE 4: WEAVING — How does the plot unfold?
    ==========================================================================
    Panel pattern: SCENE TABS → FULL SCENE ARC CONTENT
    Mirrors Inscribing's scene-tab structure: numbered scene buttons across the
    top, full content below, sequential confirmation flow. This makes Weaving
    feel like a natural precursor to Inscribing — same spatial model, lighter
    content.

    Scene tab states (matching Inscribing):
      Active    — gold fill, highest visual weight (currently being woven)
      Confirmed — gold-dim wash, settled (sealed, locked)
      Inactive  — muted surface, upcoming (not yet reachable)

    Content area shows the full scene arc for the selected scene:
      - Scene title (serif header)
      - Full narrative arc description (multiple paragraphs)
      - This is lighter than Inscribing's 8-section accordion — just the
        outline of what happens in the scene

    Footer button:
      - Scenes 1–3: "Confirm Scene Summary" (disabled until Sage signals readiness)
      - Scene 4 (last): "Continue to Inscribing" (activates when user confirms
        in chat that the last scene looks good)

    Sequential flow — Scene 1 is active first. Each confirmation locks the
    scene and advances to the next. The conversation drives content; the panel
    reflects the result.

    MOCKUP SNAPSHOT: Scene 1 active, Scenes 2–4 inactive. User and Sage are
    mid-conversation refining Scene 1's arc. "Confirm Scene Summary" is disabled.
    ==========================================================================
  -->

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Source+Serif+4:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    /* =======================================================================
       DESIGN TOKENS — Shared across all mockups
       ======================================================================= */
    :root {
      --bg-primary: #1c1b1f;
      --bg-secondary: #252428;
      --bg-surface: #2e2d32;
      --bg-surface-hover: #353439;
      --text-primary: #e8e4de;
      --text-secondary: #9d9a93;
      --text-muted: #6b6862;
      --accent-gold: #d7a964;
      --accent-gold-hover: #e5bc7a;
      --accent-gold-dim: rgba(215, 169, 100, 0.12);
      --accent-gold-border: rgba(215, 169, 100, 0.25);
      --accent-gold-glow: rgba(215, 169, 100, 0.15);
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-medium: rgba(255, 255, 255, 0.10);
      --border-hover: rgba(255, 255, 255, 0.14);
      --user-msg-bg: rgba(255, 255, 255, 0.07);
      --font-serif: 'Source Serif 4', Georgia, 'Times New Roman', serif;
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
      --message-gap: 28px;
      --section-padding: 24px;
      --panel-padding: 20px;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    /* === RESET & BASE === */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%; overflow: hidden;
      background: var(--bg-primary); color: var(--text-primary);
      font-family: var(--font-sans); font-size: 15px; line-height: 1.6;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    /* === LAYOUT === */
    .app-shell { display: flex; flex-direction: column; height: 100vh; width: 100%; }
    .app-header {
      flex-shrink: 0; display: flex; align-items: center;
      padding: 0 16px; height: 56px;
      background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle);
    }
    .app-header-home {
      display: flex; align-items: center; justify-content: center;
      width: 32px; height: 32px; border-radius: var(--radius-sm);
      background: none; border: none; color: var(--text-muted);
      cursor: pointer; transition: color 0.15s ease, background 0.15s ease; flex-shrink: 0;
    }
    .app-header-home:hover { color: var(--text-secondary); background: var(--bg-surface); }
    .app-header-title {
      font-family: var(--font-serif); font-size: 16px; font-weight: 500;
      color: var(--accent-gold); white-space: nowrap; overflow: hidden;
      text-overflow: ellipsis; min-width: 0; flex: 1; text-align: center;
    }
    .app-layout { display: grid; grid-template-columns: 13fr 7fr; flex: 1; min-height: 0; width: 100%; }

    /* === CHAT SIDE === */
    .chat-side { display: flex; flex-direction: column; min-height: 0; min-width: 0; border-right: 1px solid var(--border-subtle); }
    .message-area {
      flex: 1; overflow-y: auto; padding: 36px var(--section-padding) 8px;
      scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.08) transparent;
    }
    .message-area::-webkit-scrollbar { width: 6px; }
    .message-area::-webkit-scrollbar-track { background: transparent; }
    .message-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }
    .messages { max-width: 720px; margin: 0 auto; display: flex; flex-direction: column; gap: var(--message-gap); }
    .message { max-width: 88%; animation: message-appear 0.4s ease-out both; }
    @keyframes message-appear {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message-sage { align-self: flex-start; }
    .message-sage .message-text { font-family: var(--font-serif); font-size: 16px; }
    .message-user {
      align-self: flex-end; background: var(--user-msg-bg);
      border: 1px solid var(--border-subtle); padding: 12px 16px; border-radius: var(--radius-md);
    }
    .sage-label {
      font-family: var(--font-serif); font-size: 12px; font-weight: 500;
      color: var(--text-muted); letter-spacing: 0.03em; margin-bottom: 6px;
    }
    .message-text { color: var(--text-primary); line-height: 1.65; }
    .message-text p + p { margin-top: 12px; }
    .message:nth-child(1) { animation-delay: 0s; }
    .message:nth-child(2) { animation-delay: 0.06s; }
    .message:nth-child(3) { animation-delay: 0.12s; }
    .message:nth-child(4) { animation-delay: 0.18s; }
    .message:nth-child(5) { animation-delay: 0.24s; }
    .message:nth-child(6) { animation-delay: 0.30s; }
    .message:nth-child(7) { animation-delay: 0.36s; }

    /* === INPUT === */
    .input-area { flex-shrink: 0; padding: 12px var(--section-padding) var(--section-padding); }
    .input-container { position: relative; max-width: 720px; margin: 0 auto; }
    .chat-input {
      width: 100%; min-height: 88px; max-height: 180px;
      padding: 14px 52px 14px 18px; background: var(--bg-secondary);
      border: 1px solid var(--border-subtle); border-radius: var(--radius-lg);
      color: var(--text-primary); font-family: var(--font-sans);
      font-size: 15px; line-height: 1.55; resize: none; outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .chat-input::placeholder { color: var(--text-muted); font-style: italic; }
    .chat-input:focus { border-color: var(--accent-gold-border); box-shadow: 0 0 0 3px var(--accent-gold-glow); }
    .submit-btn {
      position: absolute; bottom: 12px; right: 12px; width: 36px; height: 36px;
      border-radius: 50%; border: none; background: var(--accent-gold);
      color: var(--bg-primary); cursor: pointer; display: flex; align-items: center;
      justify-content: center; transition: background 0.15s ease, transform 0.15s ease; opacity: 0.7;
    }
    .submit-btn:hover { background: var(--accent-gold-hover); opacity: 1; transform: scale(1.05); }
    .submit-btn svg { width: 20px; height: 20px; }

    /* === PANEL SIDE === */
    .panel-side {
      display: flex; flex-direction: column; min-height: 0; min-width: 0; background: var(--bg-secondary);
    }
    .panel-header {
      flex-shrink: 0; padding: 12px var(--panel-padding) 4px;
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
    }

    /* Phase dropdown trigger + dropdown */
    .app-header-phase {
      position: relative; display: flex; align-items: center; gap: 8px;
      cursor: pointer; padding: 4px 10px 4px 4px; border-radius: var(--radius-sm);
      border: none; background: none; transition: background 0.15s ease; flex-shrink: 0;
    }
    .app-header-phase:hover { background: var(--bg-surface); }
    .phase-name { font-family: var(--font-sans); font-size: 13px; font-weight: 500; color: var(--accent-gold); }
    .phase-progress { font-family: var(--font-sans); font-size: 12px; color: var(--text-muted); }
    .phase-chevron { color: var(--text-muted); font-size: 10px; transition: transform 0.2s ease; margin-left: -2px; }
    .phase-chevron.open { transform: rotate(180deg); }
    .phase-dropdown {
      position: absolute; top: calc(100% + 6px); left: 50%; transform: translateX(-50%);
      min-width: 260px; background: var(--bg-surface); border: 1px solid var(--border-medium);
      border-radius: var(--radius-md); box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      padding: 6px; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.15s ease;
    }
    .phase-dropdown.open { opacity: 1; pointer-events: auto; }
    .phase-dropdown-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 12px; border-radius: var(--radius-sm); font-family: var(--font-sans);
      font-size: 13px; color: var(--text-secondary); cursor: pointer;
      transition: background 0.12s ease; border: none; background: none; width: 100%; text-align: left;
    }
    .phase-dropdown-item:hover { background: var(--bg-surface-hover); }
    .phase-dropdown-item.current { color: var(--accent-gold); font-weight: 600; background: var(--accent-gold-dim); }
    .phase-dropdown-item.completed { color: var(--text-secondary); }
    .phase-dropdown-item.future { color: var(--text-muted); cursor: default; opacity: 0.6; }
    .phase-dropdown-item.future:hover { background: none; }
    .phase-item-icon { display: flex; align-items: center; flex-shrink: 0; margin-left: auto; padding-left: 12px; }
    .phase-item-icon svg { width: 12px; height: 12px; }
    .phase-item-text { display: flex; flex-direction: column; gap: 1px; min-width: 0; }
    .phase-item-desc { font-size: 11px; font-weight: 400; color: var(--text-muted); }
    .phase-dropdown-item.current .phase-item-desc { color: var(--accent-gold); opacity: 0.7; }

    /* === SCENE TABS (matching Inscribing) ===
       Three states: Active (gold fill), Confirmed (gold-dim wash), Inactive (muted).
       Sequential flow — Scene 1 is active first. Each confirmation locks the
       scene and advances to the next.
    */
    .scene-selector {
      display: flex; flex-direction: row; gap: 6px;
      padding: 0 var(--panel-padding); margin-bottom: 12px;
    }
    .scene-selector-tab {
      min-width: 48px; padding: 6px 12px; border-radius: var(--radius-sm);
      font-family: var(--font-sans); font-size: 13px;
      text-align: center; border: none;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .scene-selector-tab.active {
      background: var(--accent-gold); color: var(--bg-primary); font-weight: 600;
      cursor: default;
    }
    .scene-selector-tab.confirmed {
      background: var(--accent-gold-dim); color: var(--text-secondary);
      cursor: default;
    }
    .scene-selector-tab.inactive {
      background: var(--bg-surface); color: var(--text-secondary);
      cursor: default;
    }

    /* === SCENE ARC CONTENT (Weaving-specific) ===
       Full scene arc description shown below the scene tabs.
       Lighter than Inscribing's 8-section accordion — just narrative outline.
    */
    .panel-view {
      display: none; flex-direction: column; flex: 1; min-height: 0;
      overflow-y: auto; padding: 0 var(--panel-padding);
      scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.06) transparent;
    }
    .panel-view::-webkit-scrollbar { width: 5px; }
    .panel-view::-webkit-scrollbar-track { background: transparent; }
    .panel-view::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 3px; }
    .panel-view.active { display: flex; }

    .scene-arc-title {
      font-family: var(--font-serif); font-size: 16px; font-weight: 600;
      color: var(--text-primary); margin-bottom: 4px;
    }
    .scene-arc-subtitle {
      font-size: 12px; color: var(--text-muted); margin-bottom: 16px;
    }
    .scene-arc-body {
      flex: 1; font-size: 14px; color: var(--text-secondary); line-height: 1.65;
    }
    .scene-arc-body p + p { margin-top: 12px; }

    /* === FIXED FOOTER (matching Inscribing) === */
    .panel-footer {
      flex-shrink: 0;
      padding: 12px var(--panel-padding) 32px;
      border-top: 1px solid var(--border-subtle);
    }
    .btn-continue-compact {
      display: block; width: 100%;
      padding: 7px 16px; border: none; border-radius: var(--radius-sm);
      background: var(--accent-gold); color: var(--bg-primary);
      font-family: var(--font-sans); font-size: 13px; font-weight: 600;
      cursor: pointer; transition: background 0.15s ease, box-shadow 0.2s ease;
      letter-spacing: 0.01em; white-space: nowrap;
    }
    .btn-continue-compact:hover { background: var(--accent-gold-hover); box-shadow: 0 0 16px var(--accent-gold-glow); }
    .btn-continue-compact:disabled { opacity: 0.3; cursor: default; box-shadow: none; }
    .btn-continue-compact:disabled:hover { background: var(--accent-gold); box-shadow: none; }

    .streaming-cursor::after {
      content: '\25CB'; color: var(--accent-gold);
      animation: cursor-blink 1s step-end infinite; margin-left: 1px; font-size: 12px;
    }
    @keyframes cursor-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
    }
  </style>
</head>
<body>

  <div class="app-shell">

    <header class="app-header">
      <button class="app-header-home" aria-label="Return to home">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </button>
      <span class="app-header-title">Calamity in the Witherwild</span>
    </header>

    <div class="app-layout">

    <!-- ================================================================
         CHAT SIDE (65%)
         ================================================================ -->
    <div class="chat-side">
      <div class="message-area">
        <div class="messages">

          <!-- Sage: Opening — presents initial 4-scene outline -->
          <div class="message message-sage">
            <div class="sage-label">Sage</div>
            <div class="message-text">
              <p>The frame is bound and the Witherwild stirs. Now we weave the threads of your story into a pattern — a scene-by-scene arc that'll carry your players from first steps to final reckoning.</p>
              <p>Based on your frame and the components you've tuned — balanced tenor, discovery-led pillars, four party members at tier two — I've drafted four scenes in the panel. They move from investigation to negotiation to exploration to confrontation, which gives your players room to breathe between the tense moments.</p>
              <p>Take a look at Scene 1 and tell me what feels right, what doesn't, and where you'd push things in a different direction.</p>
            </div>
          </div>

          <!-- User: Adjusts Scene 1 concept -->
          <div class="message message-user">
            <div class="message-text">
              I like the overgrown road concept but the opening feels too slow. Can you give the party more urgency? Maybe they find something that makes it clear this isn't just abandoned infrastructure — something happened here recently.
            </div>
          </div>

          <!-- Sage: Revises Scene 1 -->
          <div class="message message-sage">
            <div class="sage-label">Sage</div>
            <div class="message-text">
              <p>Good instinct — opening scenes at tier two should hit the ground running. I've reworked the arc. Instead of a slow discovery, the party arrives to find a merchant caravan <strong>still burning</strong> — the attack happened within the hour. Scattered cargo, overturned wagons, and drag marks leading into the overgrowth.</p>
              <p>That gives you immediate stakes: someone might still be alive in there. The investigation pillar kicks in naturally — the party has to read the scene to understand what attacked, and the drag marks create a ticking clock.</p>
              <p>I've updated the arc in the panel. Take a look and let me know if that's the urgency you wanted.</p>
            </div>
          </div>

          <!-- User: Approves, asks about survivors -->
          <div class="message message-user">
            <div class="message-text">
              Much better. The burning caravan is great. But what about survivors? I don't want the party to just find bodies — I want them to find someone who can tell them what's happening.
            </div>
          </div>

          <!-- Sage: Adds survivor beat, streaming -->
          <div class="message message-sage">
            <div class="sage-label">Sage</div>
            <div class="message-text">
              <p>Perfect — a survivor gives you a voice for the exposition instead of making the party read environmental clues alone. I've added <strong>Merchant Ves</strong> to the arc: a half-conscious trader pinned under a collapsed wagon, babbling about vines that moved like they were hunting. She's injured but lucid enough to describe what she saw — and to beg the party not to follow the drag marks.</p>
              <p>That sets up a clean choice: help Ves and lose time, or follow the drag marks while the trail is fresh. Both are valid and both have consequences. I've updated the panel — this is feeling close to ready.<span class="streaming-cursor"></span></p>
            </div>
          </div>

        </div>
      </div>

      <div class="input-area">
        <div class="input-container">
          <textarea class="chat-input" placeholder="Adjust the scene arc, request changes, or confirm when ready…" rows="3"></textarea>
          <button class="submit-btn" aria-label="Send message">
            <svg viewBox="0 0 24 24" fill="currentColor" stroke="none">
              <polygon points="12,2 16,12 12,22 8,12"></polygon>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- ================================================================
         PANEL SIDE (35%) — Scene Tabs + Scene Arc Content
         ================================================================ -->
    <div class="panel-side">

      <div class="panel-header">
        <div class="app-header-phase" onclick="togglePhaseDropdown()" role="button" tabindex="0" aria-expanded="false" aria-haspopup="true">
          <span class="phase-name">Weaving</span>
          <span class="phase-progress">How does the plot unfold?</span>
          <span class="phase-chevron" id="phase-chevron">&#9662;</span>

          <!-- 6-stage dropdown (Conjuring/Summoning/Enchanting/Scrying absorbed into Inscribing) -->
          <div class="phase-dropdown" id="phase-dropdown" role="menu">
            <div class="phase-dropdown-item completed" role="menuitem" tabindex="0">
              <div class="phase-item-text"><span>Invoking</span><span class="phase-item-desc">What shape will your adventure take?</span></div>
            </div>
            <div class="phase-dropdown-item completed" role="menuitem" tabindex="0">
              <div class="phase-item-text"><span>Attuning</span><span class="phase-item-desc">How should it feel?</span></div>
            </div>
            <div class="phase-dropdown-item completed" role="menuitem" tabindex="0">
              <div class="phase-item-text"><span>Binding</span><span class="phase-item-desc">Which frame holds the story?</span></div>
            </div>
            <div class="phase-dropdown-item current" role="menuitem" tabindex="0">
              <div class="phase-item-text"><span>Weaving</span><span class="phase-item-desc">How does the plot unfold?</span></div>
            </div>
            <div class="phase-dropdown-item future" role="menuitem" tabindex="-1">
              <div class="phase-item-text"><span>Inscribing</span><span class="phase-item-desc">What unfolds in each scene?</span></div>
              <span class="phase-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></span>
            </div>
            <div class="phase-dropdown-item future" role="menuitem" tabindex="-1">
              <div class="phase-item-text"><span>Delivering</span><span class="phase-item-desc">Your tale awaits</span></div>
              <span class="phase-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Scene Tabs — Scene 1 active, Scenes 2–4 inactive -->
      <div class="scene-selector">
        <button class="scene-selector-tab active">Scene 1</button>
        <button class="scene-selector-tab inactive">Scene 2</button>
        <button class="scene-selector-tab inactive">Scene 3</button>
        <button class="scene-selector-tab inactive">Scene 4</button>
      </div>

      <!-- ============================================================
           VIEW: Scene 1 — The Overgrown Road (active)
           ============================================================ -->
      <div class="panel-view active" id="scene-1-view">
        <div class="scene-arc-title">The Overgrown Road</div>
        <div class="scene-arc-body">
          <p>The party arrives at a trade route consumed by the Witherwild to find a merchant caravan still burning — the attack happened within the hour. Scattered cargo, overturned wagons, and drag marks leading into the overgrowth. This isn't ancient history. Something is actively hunting.</p>
          <p>Pinned under a collapsed wagon, they find <strong>Merchant Ves</strong> — a half-conscious trader babbling about vines that moved like they were hunting. She's injured but lucid enough to describe what she saw: tendrils erupting from the road surface, grabbing her guards, dragging them into the tree line. She begs the party not to follow.</p>
          <p>The drag marks create a ticking clock. The investigation pillar kicks in naturally — the party has to read the scene to understand what attacked and decide what to do. Two paths emerge: help Ves and lose time (she knows the road, can describe what's ahead), or follow the drag marks while the trail is fresh (might find survivors, but the overgrowth is closing in).</p>
          <p>Either choice feeds into Scene 2. Helping Ves earns an ally with local knowledge. Following the drag marks leads to a first encounter with the Witherwild's active hostility — and a terrified survivor who knows about Wickling Hollow.</p>
        </div>
      </div>

      <!-- ============================================================
           VIEW: Scene 2 — Wickling Hollow (inactive, not shown)
           ============================================================ -->
      <div class="panel-view" id="scene-2-view">
        <div class="scene-arc-title">Wickling Hollow</div>
        <div class="scene-arc-body">
          <p>A hidden forest settlement where the party must negotiate with Wickling elders who distrust outsiders — especially anyone connected to Haven. Elder Thornveil offers guarded hospitality but demands to know their purpose.</p>
          <p>The core tension is negotiation: the Wicklings possess knowledge of the Reaping Eye's location, but they won't share it freely. A Blightcrawler nest threatens the Hollow's water supply, and Thornveil offers a trade — help purge the nest, and she'll share what she knows.</p>
          <p>A complication arrives in the form of Corporal Dace, a wounded Havenite scout held prisoner. He claims a shortcut to the Eye. The party faces a three-way choice: side with the Wicklings, trust Dace, or negotiate a compromise that unites both factions' knowledge.</p>
        </div>
      </div>

      <!-- ============================================================
           VIEW: Scene 3 — The Reaping Eye (inactive, not shown)
           ============================================================ -->
      <div class="panel-view" id="scene-3-view">
        <div class="scene-arc-title">The Reaping Eye</div>
        <div class="scene-arc-body">
          <p>Deep into the overgrowth, the party discovers the stolen artifact isn't just sitting in a clearing — it's guarded by the forest itself. An overgrown sanctum where the Witherwild tests intruders with living bramble walls, shifting paths, and a final trial.</p>
          <p>The trial forces the party to prove they understand what the Reaping Eye actually does — not just a weapon or a tool, but a lens through which the forest sees and judges. Discovery-pillar scene that's earned, not handed over.</p>
          <p>The consequences of Scene 2 ripple through here: Wickling allies make the sanctum navigable; Dace's shortcut triggers incendiary charges that accelerate the Witherwild's hostility; the compromise path provides the most resources but the sanctum is harder.</p>
        </div>
      </div>

      <!-- ============================================================
           VIEW: Scene 4 — Nikta's Judgment (inactive, not shown)
           ============================================================ -->
      <div class="panel-view" id="scene-4-view">
        <div class="scene-arc-title">Nikta's Judgment</div>
        <div class="scene-arc-body">
          <p>Confrontation at the Great Owl Nikta's corrupted sanctum, where the party must choose between restoring the Eye or destroying it. Nikta is not a simple antagonist — she let Haven take the Eye as a test, and now she's judging whether mortals deserve the forest's trust.</p>
          <p>The party's choices across all three previous scenes determine Nikta's disposition: allies earned, bridges burned, and knowledge gained all factor into how this final scene unfolds. Multiple endings are possible, from alliance to destruction to a fragile compromise.</p>
          <p>The confrontation pillar finally takes center stage, but the resolution depends on everything that came before. A party that fought its way here faces a very different Nikta than one that earned the forest's respect.</p>
        </div>
      </div>

      <!-- Fixed Footer — always visible at bottom of panel -->
      <div class="panel-footer">
        <button class="btn-continue-compact" disabled>Confirm Scene Summary</button>
      </div>

    </div>

    </div><!-- /app-layout -->
  </div><!-- /app-shell -->

  <script>
    /* === Phase Dropdown === */
    function togglePhaseDropdown() {
      const dropdown = document.getElementById('phase-dropdown');
      const chevron = document.getElementById('phase-chevron');
      const trigger = document.querySelector('.app-header-phase');
      const isOpen = dropdown.classList.contains('open');
      if (isOpen) {
        dropdown.classList.remove('open'); chevron.classList.remove('open');
        trigger.setAttribute('aria-expanded', 'false');
      } else {
        dropdown.classList.add('open'); chevron.classList.add('open');
        trigger.setAttribute('aria-expanded', 'true');
      }
    }

    document.addEventListener('click', function(e) {
      const trigger = document.querySelector('.app-header-phase');
      const dropdown = document.getElementById('phase-dropdown');
      if (!trigger.contains(e.target)) {
        dropdown.classList.remove('open');
        document.getElementById('phase-chevron').classList.remove('open');
        trigger.setAttribute('aria-expanded', 'false');
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const dropdown = document.getElementById('phase-dropdown');
        if (dropdown.classList.contains('open')) {
          dropdown.classList.remove('open');
          document.getElementById('phase-chevron').classList.remove('open');
          document.querySelector('.app-header-phase').setAttribute('aria-expanded', 'false');
        }
      }
    });

    /* === Textarea Auto-resize === */
    const textarea = document.querySelector('.chat-input');
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 180) + 'px';
    });

    /* === Scroll chat to bottom === */
    document.querySelector('.message-area').scrollTop = document.querySelector('.message-area').scrollHeight;
  </script>

</body>
</html>
