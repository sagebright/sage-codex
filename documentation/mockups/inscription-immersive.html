<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dagger-App — Inscription (Immersive Mockup)</title>

  <!--
    ==========================================================================
    STAGE 5: INSCRIPTION — What unfolds in each scene?
    ==========================================================================
    Panel pattern: SECTION ACCORDION → DETAIL CARDS (narrative + entity)
    The user inscribes each scene into the Book through a draft-feedback-revise
    cycle with the Sage. The panel shows scene tabs and 9 collapsible sections
    per scene, organized in three waves:

      Wave 1 (Primary Narrative): Overview, Setup, Developments
      Wave 2 (Entities): NPCs Present, Adversaries, Items
      Wave 3 (Synthesis): Transitions, Portents, GM Notes

    Three scene tab states:
      Active    — gold fill, highest visual weight (currently being inscribed)
      Confirmed — gold-dim wash, settled (sealed, not interactive)
      Inactive  — muted surface, upcoming (not yet reachable)

    Two-level navigation reusing Binding's gallery↔detail pattern:
      Section List (accordion) — scan 9 sections at a glance
      Section Detail Card — full content with read-aloud blocks (narrative)
                          or full entity treatment (NPC/adversary drill-in)

    Four interaction patterns per section type:
      Narrative (Setup, Developments, Transitions):
        Accordion → descriptive text; Click name → detail card with read-aloud
      Accordion-only (Overview, GM Notes):
        Expand inline, no drill-in
      Entity (NPCs Present, Adversaries):
        Accordion → compact entity cards; Click entity → entity detail card
      Items:
        Accordion → Enchanting-style item cards; no drill-in
      Portents (echo categories):
        Accordion → category list with counts; Click category → detail card
        with trigger/benefit/complication echo entries

    Inscription absorbs former stages Conjuring (NPCs), Summoning (adversaries),
    Enchanting (items), and Scrying (echoes) — reducing the ritual from 10
    stages to 6.

    MOCKUP SNAPSHOT: Scene 1 confirmed, Scene 2 active. Wave 1 populated,
    Wave 2 partially populated, Wave 3 dimmed. Chat shows draft-feedback-revise.
    ==========================================================================
  -->

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Source+Serif+4:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    /* =======================================================================
       DESIGN TOKENS — Shared across all mockups
       ======================================================================= */
    :root {
      --bg-primary: #1c1b1f;
      --bg-secondary: #252428;
      --bg-surface: #2e2d32;
      --bg-surface-hover: #353439;
      --text-primary: #e8e4de;
      --text-secondary: #9d9a93;
      --text-muted: #6b6862;
      --accent-gold: #d7a964;
      --accent-gold-hover: #e5bc7a;
      --accent-gold-dim: rgba(215, 169, 100, 0.12);
      --accent-gold-border: rgba(215, 169, 100, 0.25);
      --accent-gold-glow: rgba(215, 169, 100, 0.15);
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-medium: rgba(255, 255, 255, 0.10);
      --border-hover: rgba(255, 255, 255, 0.14);
      --user-msg-bg: rgba(255, 255, 255, 0.07);
      --font-serif: 'Source Serif 4', Georgia, 'Times New Roman', serif;
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
      --message-gap: 28px;
      --section-padding: 24px;
      --panel-padding: 20px;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    /* === RESET & BASE === */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%; overflow: hidden;
      background: var(--bg-primary); color: var(--text-primary);
      font-family: var(--font-sans); font-size: 15px; line-height: 1.6;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    /* === LAYOUT === */
    .app-shell { display: flex; flex-direction: column; height: 100vh; width: 100%; }
    .app-header {
      flex-shrink: 0; display: flex; align-items: center;
      padding: 0 16px; height: 56px;
      background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle);
    }
    .app-header-home {
      display: flex; align-items: center; justify-content: center;
      width: 32px; height: 32px; border-radius: var(--radius-sm);
      background: none; border: none; color: var(--text-muted);
      cursor: pointer; transition: color 0.15s ease, background 0.15s ease; flex-shrink: 0;
    }
    .app-header-home:hover { color: var(--text-secondary); background: var(--bg-surface); }
    .app-header-title {
      font-family: var(--font-serif); font-size: 16px; font-weight: 500;
      color: var(--accent-gold); white-space: nowrap; overflow: hidden;
      text-overflow: ellipsis; min-width: 0; flex: 1; text-align: center;
    }
    .app-layout { display: grid; grid-template-columns: 13fr 7fr; flex: 1; min-height: 0; width: 100%; }

    /* === CHAT SIDE === */
    .chat-side { display: flex; flex-direction: column; min-height: 0; border-right: 1px solid var(--border-subtle); }
    .message-area {
      flex: 1; overflow-y: auto; padding: 36px var(--section-padding) 8px;
      scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.08) transparent;
    }
    .message-area::-webkit-scrollbar { width: 6px; }
    .message-area::-webkit-scrollbar-track { background: transparent; }
    .message-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }
    .messages { max-width: 720px; margin: 0 auto; display: flex; flex-direction: column; gap: var(--message-gap); }
    .message { max-width: 88%; animation: message-appear 0.4s ease-out both; }
    @keyframes message-appear {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message-sage { align-self: flex-start; }
    .message-sage .message-text { font-family: var(--font-serif); font-size: 16px; }
    .message-user {
      align-self: flex-end; background: var(--user-msg-bg);
      border: 1px solid var(--border-subtle); padding: 12px 16px; border-radius: var(--radius-md);
    }
    .sage-label {
      font-family: var(--font-serif); font-size: 12px; font-weight: 500;
      color: var(--text-muted); letter-spacing: 0.03em; margin-bottom: 6px;
    }
    .message-text { color: var(--text-primary); line-height: 1.65; }
    .message-text p + p { margin-top: 12px; }
    .message:nth-child(1) { animation-delay: 0s; }
    .message:nth-child(2) { animation-delay: 0.06s; }
    .message:nth-child(3) { animation-delay: 0.12s; }
    .message:nth-child(4) { animation-delay: 0.18s; }
    .message:nth-child(5) { animation-delay: 0.24s; }
    .message:nth-child(6) { animation-delay: 0.30s; }

    /* === INPUT === */
    .input-area { flex-shrink: 0; padding: 12px var(--section-padding) var(--section-padding); }
    .input-container { position: relative; max-width: 720px; margin: 0 auto; }
    .chat-input {
      width: 100%; min-height: 88px; max-height: 180px;
      padding: 14px 52px 14px 18px; background: var(--bg-secondary);
      border: 1px solid var(--border-subtle); border-radius: var(--radius-lg);
      color: var(--text-primary); font-family: var(--font-sans);
      font-size: 15px; line-height: 1.55; resize: none; outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .chat-input::placeholder { color: var(--text-muted); font-style: italic; }
    .chat-input:focus { border-color: var(--accent-gold-border); box-shadow: 0 0 0 3px var(--accent-gold-glow); }
    .submit-btn {
      position: absolute; bottom: 12px; right: 12px; width: 36px; height: 36px;
      border-radius: 50%; border: none; background: var(--accent-gold);
      color: var(--bg-primary); cursor: pointer; display: flex; align-items: center;
      justify-content: center; transition: background 0.15s ease, transform 0.15s ease; opacity: 0.7;
    }
    .submit-btn:hover { background: var(--accent-gold-hover); opacity: 1; transform: scale(1.05); }
    .submit-btn svg { width: 20px; height: 20px; }

    /* === PANEL SIDE === */
    .panel-side {
      display: flex; flex-direction: column; min-height: 0; background: var(--bg-secondary);
    }
    .panel-header {
      flex-shrink: 0; padding: 12px var(--panel-padding) 4px;
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
    }

    /* Phase dropdown trigger + dropdown */
    .app-header-phase {
      position: relative; display: flex; align-items: center; gap: 8px;
      cursor: pointer; padding: 4px 10px 4px 4px; border-radius: var(--radius-sm);
      border: none; background: none; transition: background 0.15s ease; flex-shrink: 0;
    }
    .app-header-phase:hover { background: var(--bg-surface); }
    .phase-name { font-family: var(--font-sans); font-size: 13px; font-weight: 500; color: var(--accent-gold); }
    .phase-progress { font-family: var(--font-sans); font-size: 12px; color: var(--text-muted); }
    .phase-chevron { color: var(--text-muted); font-size: 10px; transition: transform 0.2s ease; margin-left: -2px; }
    .phase-chevron.open { transform: rotate(180deg); }
    .phase-dropdown {
      position: absolute; top: calc(100% + 6px); left: 50%; transform: translateX(-50%);
      min-width: 260px; background: var(--bg-surface); border: 1px solid var(--border-medium);
      border-radius: var(--radius-md); box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      padding: 6px; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.15s ease;
    }
    .phase-dropdown.open { opacity: 1; pointer-events: auto; }
    .phase-dropdown-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 12px; border-radius: var(--radius-sm); font-family: var(--font-sans);
      font-size: 13px; color: var(--text-secondary); cursor: pointer;
      transition: background 0.12s ease; border: none; background: none; width: 100%; text-align: left;
    }
    .phase-dropdown-item:hover { background: var(--bg-surface-hover); }
    .phase-dropdown-item.current { color: var(--accent-gold); font-weight: 600; background: var(--accent-gold-dim); }
    .phase-dropdown-item.completed { color: var(--text-secondary); }
    .phase-dropdown-item.future { color: var(--text-muted); cursor: default; opacity: 0.6; }
    .phase-dropdown-item.future:hover { background: none; }
    .phase-item-icon { display: flex; align-items: center; flex-shrink: 0; margin-left: auto; padding-left: 12px; }
    .phase-item-icon svg { width: 12px; height: 12px; }
    .phase-item-text { display: flex; flex-direction: column; gap: 1px; min-width: 0; }
    .phase-item-desc { font-size: 11px; font-weight: 400; color: var(--text-muted); }
    .phase-dropdown-item.current .phase-item-desc { color: var(--accent-gold); opacity: 0.7; }

    /* === SCENE TABS ===
       Three states: Active (gold fill), Confirmed (gold-dim wash), Inactive (muted).
       Sequential flow — only the active tab is interactive. Confirmed tabs are
       sealed (no going back). Inactive tabs are not yet reachable.
    */
    .scene-selector {
      display: flex; flex-direction: row; gap: 6px;
      padding: 0 var(--panel-padding); margin-bottom: 12px;
    }
    .scene-selector-tab {
      min-width: 48px; padding: 6px 12px; border-radius: var(--radius-sm);
      font-family: var(--font-sans); font-size: 13px;
      text-align: center; border: none;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .scene-selector-tab.active {
      background: var(--accent-gold); color: var(--bg-primary); font-weight: 600;
      cursor: default;
    }
    .scene-selector-tab.confirmed {
      background: var(--accent-gold-dim); color: var(--text-secondary);
      cursor: default;
    }
    .scene-selector-tab.inactive {
      background: var(--bg-surface); color: var(--text-secondary);
      cursor: default;
    }

    /* === PANEL VIEWS ===
       Multiple views share the same flex slot. Only one visible at a time.
       Cross-fade transitions between views match Binding's gallery↔detail.
    */
    .panel-view {
      display: none; flex-direction: column; flex: 1; min-height: 0;
      overflow-y: auto; padding: 0 var(--panel-padding);
      scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.06) transparent;
    }
    .panel-view::-webkit-scrollbar { width: 5px; }
    .panel-view::-webkit-scrollbar-track { background: transparent; }
    .panel-view::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 3px; }
    .panel-view.active { display: flex; }

    /* === SECTION ACCORDION ===
       9 collapsible sections per scene. Chevron rotates on expand.
       No status dots — the flow is conversational, not checkbox-driven.
    */
    .scene-section { margin-bottom: 2px; }
    .scene-section-header {
      display: flex; flex-direction: row; align-items: center;
      padding: 10px 12px; border-radius: var(--radius-sm);
      transition: background 0.12s ease; gap: 8px; user-select: none;
    }
    .scene-section-header:hover { background: var(--bg-surface); }

    .scene-section-chevron {
      font-size: 10px; color: var(--text-muted); flex-shrink: 0;
      transition: transform 0.2s ease; width: 16px; text-align: center;
      cursor: pointer; padding: 4px 0;
    }
    .scene-section:not(.collapsed) .scene-section-chevron {
      transform: rotate(90deg);
    }
    /* Expanded sections: title and icon go gold (matches Binding frame pattern) */
    .scene-section:not(.collapsed) .scene-section-name {
      color: var(--accent-gold);
    }
    .scene-section:not(.collapsed) .speaking-icon {
      color: var(--accent-gold);
    }

    .scene-section-name {
      font-family: var(--font-sans); font-size: 13px; font-weight: 500;
      color: var(--text-primary); flex: 1; min-width: 0;
    }
    /* Narrative section names are clickable — open detail card */
    .scene-section.has-detail .scene-section-name {
      cursor: pointer; transition: color 0.15s ease;
    }
    .scene-section.has-detail .scene-section-name:hover {
      color: var(--accent-gold);
    }

    /* Speaking icon — indicates read-aloud content behind click-through */
    .speaking-icon {
      flex-shrink: 0; width: 16px; height: 16px;
      color: var(--text-muted); transition: color 0.15s ease;
      cursor: pointer;
    }
    .scene-section.has-detail:hover .speaking-icon,
    .speaking-icon:hover {
      color: var(--accent-gold);
    }

    .scene-section-preview {
      padding: 0 12px 12px 36px;
      font-family: var(--font-sans); font-size: 13px; color: var(--text-secondary);
      line-height: 1.5;
    }
    .scene-section.collapsed .scene-section-preview {
      display: none;
    }
    .scene-section-meta {
      font-size: 12px; color: var(--text-muted); font-style: italic;
    }

    /* Wave 3 inactive — dimmed, non-interactive */
    .scene-section.wave3-inactive {
      opacity: 0.4;
    }
    .scene-section.wave3-inactive .scene-section-header {
      cursor: default; pointer-events: none;
    }
    .scene-section.wave3-inactive .scene-section-header:hover {
      background: none;
    }
    .scene-section.wave3-inactive .scene-section-chevron {
      cursor: default;
    }

    /* === BACK BUTTON === */
    .back-btn {
      display: flex; align-items: center; gap: 6px;
      background: none; border: none;
      color: var(--text-muted); font-family: var(--font-sans);
      font-size: 13px; cursor: pointer; padding: 4px 0;
      transition: color 0.15s ease;
    }
    .back-btn:hover { color: var(--accent-gold); }

    /* === DETAIL CARD (shared for narrative + entity) ===
       Replaces accordion view. "Back to Scene" at top, content below.
    */
    .detail-card-header {
      flex-shrink: 0; padding: 8px 0 4px;
    }
    .detail-card-title {
      font-family: var(--font-serif); font-size: 16px; font-weight: 600;
      color: var(--text-primary); margin-top: 8px;
    }
    .detail-card-subtitle {
      font-size: 13px; color: var(--text-secondary); margin-top: 2px;
    }
    .detail-card-body {
      flex: 1; padding: 12px 0 20px;
      font-size: 14px; color: var(--text-secondary); line-height: 1.65;
    }
    .detail-card-body p + p { margin-top: 12px; }

    /* === READ-ALOUD BLOCKS ===
       Gold left border, gold-dim background, serif italic, "Read Aloud" label.
       Only appears in detail cards, never in accordion previews.
    */
    .read-aloud {
      margin: 16px 0;
      padding: 14px 16px 14px 16px;
      border-left: 3px solid var(--accent-gold);
      background: var(--accent-gold-dim);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }
    .read-aloud-label {
      font-family: var(--font-sans); font-size: 11px; font-weight: 500;
      color: var(--text-muted); letter-spacing: 0.04em;
      text-transform: uppercase; margin-bottom: 8px;
    }
    .read-aloud-text {
      font-family: var(--font-serif); font-size: 15px; font-style: italic;
      color: var(--text-primary); line-height: 1.7;
    }

    /* === ENTITY CARDS (NPC + Adversary) ===
       Name + description. Clickable → detail card drill-in.
    */
    .entity-list { padding: 4px 0 8px 0; }
    .entity-card {
      display: flex; flex-direction: row; align-items: center;
      padding: 10px 12px; gap: 10px;
      border-radius: var(--radius-sm); cursor: pointer;
      transition: background 0.15s ease;
    }
    .entity-card:hover { background: var(--bg-surface); }
    .entity-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--bg-surface); flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-family: var(--font-serif); font-size: 13px; font-weight: 500;
      color: var(--text-secondary); border: 1.5px solid var(--border-medium);
    }
    .entity-info { display: flex; flex-direction: column; flex: 1; min-width: 0; gap: 2px; }
    .entity-name {
      font-size: 13px; font-weight: 600; color: var(--text-primary); line-height: 1.3;
    }
    .entity-role-tag {
      display: inline-block; font-size: 11px; font-weight: 500;
      color: var(--text-muted); border: 1px solid var(--border-medium);
      border-radius: 12px; padding: 1px 8px; white-space: nowrap; width: fit-content;
    }
    /* NPC role color variants — warm, human tones */
    .entity-role-tag.role-leader {
      color: #d4a574; border-color: rgba(212, 165, 116, 0.35);
      background: rgba(212, 165, 116, 0.08);
    }
    .entity-role-tag.role-antagonist {
      color: #db7e7e; border-color: rgba(219, 126, 126, 0.35);
      background: rgba(219, 126, 126, 0.08);
    }
    .entity-role-tag.role-oracle {
      color: #8bc4a8; border-color: rgba(139, 196, 168, 0.35);
      background: rgba(139, 196, 168, 0.08);
    }
    .entity-role-tag.role-scout {
      color: #8badc4; border-color: rgba(139, 173, 196, 0.35);
      background: rgba(139, 173, 196, 0.08);
    }
    .entity-role-tag.role-minor {
      color: #a09590; border-color: rgba(160, 149, 144, 0.35);
      background: rgba(160, 149, 144, 0.08);
    }
    .entity-desc {
      font-size: 12px; color: var(--text-secondary); line-height: 1.5;
    }

    /* === NPC DETAIL CARD ===
       Full NPC treatment with collapsible sub-sections.
    */
    .npc-detail-header {
      display: flex; align-items: center; gap: 12px; margin: 12px 0 4px;
    }
    .npc-detail-avatar {
      width: 48px; height: 48px; border-radius: 50%;
      background: var(--bg-surface); flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-family: var(--font-serif); font-size: 16px; font-weight: 500;
      color: var(--accent-gold); border: 1.5px solid var(--accent-gold-border);
    }
    .npc-detail-identity { display: flex; flex-direction: column; gap: 4px; }
    .npc-detail-name {
      font-family: var(--font-serif); font-size: 18px; font-weight: 600;
      color: var(--text-primary);
    }

    .npc-field { margin-bottom: 16px; }
    .npc-field-label {
      font-family: var(--font-sans); font-size: 11px; font-weight: 600;
      color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em;
      margin-bottom: 4px;
    }
    .npc-field-value {
      font-size: 14px; color: var(--text-secondary); line-height: 1.6;
    }

    /* === ADVERSARY COMPACT CARDS ===
       Name + type badge + difficulty. Clickable → adversary detail card.
    */
    .adversary-type-badge {
      display: inline-block; font-size: 11px; font-weight: 500;
      border-radius: 12px; padding: 1px 8px; white-space: nowrap;
    }
    .adversary-type-badge.type-bruiser {
      color: #e07c5a; border: 1px solid rgba(224, 124, 90, 0.35);
      background: rgba(224, 124, 90, 0.08);
    }
    .adversary-type-badge.type-minion {
      color: #8b9dc3; border: 1px solid rgba(139, 157, 195, 0.35);
      background: rgba(139, 157, 195, 0.08);
    }
    .adversary-type-badge.type-leader {
      color: #c98bdb; border: 1px solid rgba(201, 139, 219, 0.35);
      background: rgba(201, 139, 219, 0.08);
    }
    .adversary-type-badge.type-solo {
      color: #db6b6b; border: 1px solid rgba(219, 107, 107, 0.35);
      background: rgba(219, 107, 107, 0.08);
    }
    .adversary-compact-meta {
      font-size: 12px; color: var(--text-muted); margin-top: 2px;
    }

    /* === ADVERSARY DETAIL CARD — Stat block === */
    .stat-block {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      gap: 8px; padding: 12px;
      background: var(--bg-surface); border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle); margin: 12px 0;
    }
    .stat-item {
      display: flex; flex-direction: column; gap: 2px;
    }
    .stat-label {
      font-size: 10px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.06em;
    }
    .stat-value {
      font-size: 14px; font-weight: 600; color: var(--text-primary);
    }
    .stat-block-wide {
      grid-column: span 3;
    }

    .adversary-section { margin-bottom: 16px; }
    .adversary-section-label {
      font-size: 11px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 6px;
    }
    .adversary-section-text {
      font-size: 13px; color: var(--text-secondary); line-height: 1.6;
    }
    .adversary-feature {
      padding: 8px 0; border-bottom: 1px solid var(--border-subtle);
    }
    .adversary-feature:last-child { border-bottom: none; }
    .adversary-feature-name {
      font-size: 13px; font-weight: 600; color: var(--text-primary);
    }
    .adversary-feature-desc {
      font-size: 13px; color: var(--text-secondary); margin-top: 2px;
    }
    .threshold-row {
      display: flex; gap: 16px; font-size: 13px; color: var(--text-secondary);
    }
    .threshold-item { display: flex; gap: 4px; }
    .threshold-label { font-weight: 600; color: var(--text-muted); }

    /* === ITEM CARDS (Enchanting pattern) === */
    .item-card {
      padding: 10px 12px; border-left: 3px solid transparent;
      border-radius: var(--radius-sm); margin-bottom: 4px;
      transition: background 0.12s ease;
    }
    .item-card:hover { background: var(--bg-surface); }
    .item-card.assigned { border-left-color: var(--accent-gold); }
    .item-card-header { display: flex; align-items: center; gap: 8px; }
    .item-card-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .item-type-label {
      font-size: 10px; font-weight: 500; color: var(--text-muted);
      border: 1px solid var(--border-medium); border-radius: 10px;
      padding: 1px 7px; text-transform: uppercase; letter-spacing: 0.04em;
    }
    /* Item type color variants — material/object tones */
    .item-type-label.type-weapon {
      color: #d4836d; border-color: rgba(212, 131, 109, 0.35);
      background: rgba(212, 131, 109, 0.08);
    }
    .item-type-label.type-armor {
      color: #8b9fb8; border-color: rgba(139, 159, 184, 0.35);
      background: rgba(139, 159, 184, 0.08);
    }
    .item-type-label.type-consumable {
      color: #8bc4a8; border-color: rgba(139, 196, 168, 0.35);
      background: rgba(139, 196, 168, 0.08);
    }
    .item-type-label.type-item {
      color: #c4b08b; border-color: rgba(196, 176, 139, 0.35);
      background: rgba(196, 176, 139, 0.08);
    }
    .item-card-stat {
      font-size: 12px; color: var(--text-secondary); margin-top: 2px; padding-left: 0;
    }

    /* === FIXED FOOTER === */
    .panel-footer {
      flex-shrink: 0;
      padding: 12px var(--panel-padding) 32px;
      border-top: 1px solid var(--border-subtle);
    }
    .btn-continue-compact {
      display: block; width: 100%;
      padding: 7px 16px; border: none; border-radius: var(--radius-sm);
      background: var(--accent-gold); color: var(--bg-primary);
      font-family: var(--font-sans); font-size: 13px; font-weight: 600;
      cursor: pointer; transition: background 0.15s ease, box-shadow 0.2s ease;
      letter-spacing: 0.01em; white-space: nowrap;
    }
    .btn-continue-compact:hover { background: var(--accent-gold-hover); box-shadow: 0 0 16px var(--accent-gold-glow); }
    .btn-continue-compact:disabled { opacity: 0.3; cursor: default; box-shadow: none; }
    .btn-continue-compact:disabled:hover { background: var(--accent-gold); box-shadow: none; }

    /* === PORTENTS / ECHO STYLES (from Scrying mockup) === */
    .echo-category { margin-bottom: 2px; }
    .echo-category-header {
      display: flex; flex-direction: row; align-items: center;
      padding: 10px 12px; cursor: pointer; border-radius: var(--radius-sm);
      transition: background 0.12s ease; border: none; background: none; width: 100%;
    }
    .echo-category-header:hover { background: var(--bg-surface); }
    .echo-category-chevron {
      transition: transform 0.2s ease; margin-right: 8px;
      color: var(--text-muted); font-size: 12px; flex-shrink: 0;
    }
    .echo-category.expanded .echo-category-chevron { transform: rotate(90deg); }
    .echo-category-name {
      font-family: var(--font-sans); font-size: 13px; font-weight: 500;
      color: var(--text-primary); flex: 1; text-align: left;
    }
    .echo-category.expanded .echo-category-name { color: var(--accent-gold); }
    .echo-category-count {
      font-family: var(--font-sans); font-size: 11px;
      color: var(--text-muted); font-weight: 500; flex-shrink: 0;
    }
    .echo-category-content {
      padding: 0 12px 12px 28px;
      display: none;
    }
    .echo-category.expanded .echo-category-content { display: block; }
    .echo-entry {
      margin-bottom: 16px; padding-bottom: 16px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .echo-entry:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .echo-title {
      font-family: var(--font-serif); font-size: 14px; font-weight: 600;
      color: var(--accent-gold); margin-bottom: 8px;
    }
    .echo-field { margin-bottom: 6px; font-size: 13px; line-height: 1.5; }
    .echo-field:last-child { margin-bottom: 0; }
    .echo-field-label {
      font-family: var(--font-sans); font-weight: 500; font-size: 12px;
      display: block; margin-bottom: 2px;
    }
    .echo-field-label.trigger { color: var(--text-primary); }
    .echo-field-label.benefit { color: var(--text-primary); }
    .echo-field-label.complication { color: var(--text-primary); }
    .echo-field-text { color: var(--text-secondary); font-size: 13px; line-height: 1.5; }

    .streaming-cursor::after {
      content: '\25CB'; color: var(--accent-gold);
      animation: cursor-blink 1s step-end infinite; margin-left: 1px; font-size: 12px;
    }
    @keyframes cursor-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
    }
  </style>
</head>
<body>

  <div class="app-shell">

    <header class="app-header">
      <button class="app-header-home" aria-label="Return to home">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </button>
      <span class="app-header-title">Calamity in the Witherwild</span>
    </header>

    <div class="app-layout">

    <!-- ================================================================
         CHAT SIDE (65%)
         ================================================================ -->
    <div class="chat-side">
      <div class="message-area">
        <div class="messages">

          <!-- Sage: Opening Inscription -->
          <div class="message message-sage">
            <div class="sage-label">Sage</div>
            <div class="message-text">
              <p>Your scene arc is woven and the shape of the story is clear. Now we inscribe each scene into the Book — filling in the details that'll bring them to life at the table.</p>
              <p>Scene 1 is already written and sealed. I've moved on to <strong>Scene 2: Wickling Hollow</strong> — here's my opening draft.</p>
            </div>
          </div>

          <!-- Sage: Scene 2 draft -->
          <div class="message message-sage">
            <div class="sage-label">Sage</div>
            <div class="message-text">
              <p><strong>Scene 2 — Wickling Hollow</strong></p>
              <p>The party arrives at a settlement carved into the living trunks of enormous withertrees. Bioluminescent moss lights the walkways, but the air is tense — the Wicklings haven't seen outsiders since the overgrowth began. Elder Thornveil greets the party with guarded hospitality, offering shelter but demanding to know their purpose.</p>
              <p>The core tension here is negotiation: the Wicklings possess knowledge of the Reaping Eye's location, but they won't share it freely. The party needs to earn trust — or find another way.</p>
            </div>
          </div>

          <!-- User: Expand developments -->
          <div class="message message-user">
            <div class="message-text">
              I like the setup, but the Developments section feels thin. Can you expand the negotiation? I want there to be a moment where the party has to choose between helping the Wicklings with a local threat or pushing forward on the main quest.
            </div>
          </div>

          <!-- Sage: Revised developments -->
          <div class="message message-sage">
            <div class="sage-label">Sage</div>
            <div class="message-text">
              <p>Good call — that's exactly the kind of pressure point that makes scenes memorable. Here's the revised developments:</p>
              <p>Elder Thornveil reveals that a <strong>Blightcrawler nest</strong> has taken root beneath the Hollow's water source. The Wicklings are too few to clear it themselves. She offers a trade: help purge the nest, and she'll share what she knows about the Eye's resting place.</p>
              <p>But there's a catch. A Havenite scout — <strong>Corporal Dace</strong> — is also in the Hollow, wounded and under Wickling guard. He claims to know a shortcut to the Eye, no Wickling help needed. The party can side with the Wicklings and fight the nest, trust Dace and leave immediately, or try to negotiate a compromise that satisfies both.</p>
              <p>I've updated the panel with the revised sections. Take a look — the NPCs and adversaries are shaping up too.</p>
            </div>
          </div>

          <!-- User: Approval -->
          <div class="message message-user">
            <div class="message-text">
              That's perfect. The three-way choice is exactly what I wanted. Let's keep refining — I want to check on the NPCs next.
            </div>
          </div>

        </div>
      </div>

      <div class="input-area">
        <div class="input-container">
          <textarea class="chat-input" placeholder="Refine the inscription..." rows="3"></textarea>
          <button class="submit-btn" aria-label="Send message">
            <svg viewBox="0 0 24 24" fill="currentColor" stroke="none">
              <polygon points="12,2 16,12 12,22 8,12"></polygon>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- ================================================================
         PANEL SIDE (35%) — Section Accordion + Detail Cards
         ================================================================ -->
    <div class="panel-side">

      <div class="panel-header">
        <div class="app-header-phase" onclick="togglePhaseDropdown()" role="button" tabindex="0" aria-expanded="false" aria-haspopup="true">
          <span class="phase-name">Inscription</span>
          <span class="phase-progress">What unfolds in each scene?</span>
          <span class="phase-chevron" id="phase-chevron">&#9662;</span>

          <!-- 6-stage dropdown (Conjuring/Summoning/Enchanting/Scrying absorbed into Inscription) -->
          <div class="phase-dropdown" id="phase-dropdown" role="menu">
            <div class="phase-dropdown-item completed" role="menuitem" tabindex="0">
              <div class="phase-item-text"><span>Invocation</span><span class="phase-item-desc">What shape will your adventure take?</span></div>
            </div>
            <div class="phase-dropdown-item completed" role="menuitem" tabindex="0">
              <div class="phase-item-text"><span>Attunement</span><span class="phase-item-desc">How should it feel?</span></div>
            </div>
            <div class="phase-dropdown-item completed" role="menuitem" tabindex="0">
              <div class="phase-item-text"><span>Binding</span><span class="phase-item-desc">Which frame holds the story?</span></div>
            </div>
            <div class="phase-dropdown-item completed" role="menuitem" tabindex="0">
              <div class="phase-item-text"><span>Weaving</span><span class="phase-item-desc">How does the plot unfold?</span></div>
            </div>
            <div class="phase-dropdown-item current" role="menuitem" tabindex="0">
              <div class="phase-item-text"><span>Inscription</span><span class="phase-item-desc">What unfolds in each scene?</span></div>
            </div>
            <div class="phase-dropdown-item future" role="menuitem" tabindex="-1">
              <div class="phase-item-text"><span>Sealing</span><span class="phase-item-desc">Is the spell complete?</span></div>
              <span class="phase-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Scene Tabs — Scene 1 confirmed, Scene 2 active, 3-4 inactive -->
      <div class="scene-selector">
        <button class="scene-selector-tab confirmed">Scene 1</button>
        <button class="scene-selector-tab active">Scene 2</button>
        <button class="scene-selector-tab inactive">Scene 3</button>
        <button class="scene-selector-tab inactive">Scene 4</button>
      </div>

      <!-- ============================================================
           VIEW: Section Accordion (default)
           ============================================================ -->
      <div class="panel-view active" id="accordion-view">

        <!-- WAVE 1: Primary Narrative -->

        <!-- Overview — expanded, accordion-only -->
        <div class="scene-section" data-section="overview">
          <div class="scene-section-header" onclick="toggleSection(this)">
            <span class="scene-section-chevron">&#9654;</span>
            <span class="scene-section-name">Overview</span>
          </div>
          <div class="scene-section-preview">
            The party arrives at Wickling Hollow, a settlement carved into living withertrees. Elder Thornveil offers guarded hospitality but demands to know their purpose. Trust must be earned before any knowledge of the Reaping Eye is shared.
          </div>
        </div>

        <!-- Setup — collapsed, has detail card + read-aloud -->
        <div class="scene-section collapsed has-detail" data-section="setup">
          <div class="scene-section-header">
            <span class="scene-section-chevron" onclick="toggleSection(this.closest('.scene-section-header'))">&#9654;</span>
            <span class="scene-section-name" onclick="showView('setup-detail')">Setup</span>
            <!-- Speaking icon — read-aloud content available (speech bubble) -->
            <svg class="speaking-icon" onclick="showView('setup-detail')" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <div class="scene-section-preview">
            The party arrives at a settlement carved into living withertrees. Bioluminescent moss lights the walkways, but the Wicklings haven't seen outsiders since the overgrowth began. Elder Thornveil greets them with guarded hospitality, demanding to know their purpose.
          </div>
        </div>

        <!-- Developments — expanded, has detail card + read-aloud -->
        <div class="scene-section has-detail" data-section="developments">
          <div class="scene-section-header">
            <span class="scene-section-chevron" onclick="toggleSection(this.closest('.scene-section-header'))">&#9654;</span>
            <span class="scene-section-name" onclick="showView('developments-detail')">Developments</span>
            <svg class="speaking-icon" onclick="showView('developments-detail')" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <div class="scene-section-preview">
            Elder Thornveil reveals a Blightcrawler nest beneath the Hollow's water source. She offers a trade: purge the nest, and she'll share what she knows about the Reaping Eye. Corporal Dace, a wounded Havenite scout, offers an alternative shortcut. The party must choose: help the Wicklings, trust Dace, or find a compromise.
          </div>
        </div>

        <!-- WAVE 2: Entities -->

        <!-- NPCs Present — collapsed, entity cards -->
        <div class="scene-section collapsed" data-section="npcs">
          <div class="scene-section-header" onclick="toggleSection(this)">
            <span class="scene-section-chevron">&#9654;</span>
            <span class="scene-section-name">NPCs Present</span>
          </div>
          <div class="scene-section-preview">
            <div class="entity-list">
              <div class="entity-card" onclick="event.stopPropagation(); showView('npc-thornveil-detail')">
                <div class="entity-info">
                  <div class="entity-name">Elder Thornveil</div>
                  <div class="entity-desc">Leader of the Wickling people. The last of the root-speakers — intent on restoring her people's faith.</div>
                </div>
              </div>
              <div class="entity-card" onclick="event.stopPropagation(); showView('npc-dace-detail')">
                <div class="entity-info">
                  <div class="entity-name">Corporal Dace</div>
                  <div class="entity-desc">Wounded Havenite scout. Claims to know a shortcut to the Eye, but his squad burned Wickling farmland.</div>
                </div>
              </div>
              <div class="entity-card" style="opacity: 0.6; cursor: default;">
                <div class="entity-info">
                  <div class="entity-name">Wickling Sentries</div>
                  <div class="entity-desc">Masked guards watching from elevated platforms. Loyal to Thornveil, hostile to outsiders.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Adversaries — collapsed, entity cards -->
        <div class="scene-section collapsed" data-section="adversaries">
          <div class="scene-section-header" onclick="toggleSection(this)">
            <span class="scene-section-chevron">&#9654;</span>
            <span class="scene-section-name">Adversaries</span>
          </div>
          <div class="scene-section-preview">
            <div class="entity-list">
              <div class="entity-card" onclick="event.stopPropagation(); showView('adversary-alpha-detail')">
                <div class="entity-info">
                  <div class="entity-name">Blightcrawler Alpha</div>
                  <div style="display: flex; gap: 6px; align-items: center; margin-top: 2px;">
                    <span class="adversary-type-badge type-bruiser">Bruiser</span>
                    <span class="adversary-compact-meta">Difficulty 12</span>
                  </div>
                  <div class="entity-desc">Massive centipede-like creature. Its mandibles drip a paralytic venom.</div>
                </div>
              </div>
              <div class="entity-card" onclick="event.stopPropagation();">
                <div class="entity-info">
                  <div class="entity-name">Blightcrawler Brood</div>
                  <div style="display: flex; gap: 6px; align-items: center; margin-top: 2px;">
                    <span class="adversary-type-badge type-minion">Minion</span>
                    <span class="adversary-compact-meta">Difficulty 6</span>
                  </div>
                  <div class="entity-desc">Smaller spawn that swarm in packs, coordinated by the Alpha's subsonic calls.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Items — collapsed, item cards -->
        <div class="scene-section collapsed" data-section="items">
          <div class="scene-section-header" onclick="toggleSection(this)">
            <span class="scene-section-chevron">&#9654;</span>
            <span class="scene-section-name">Items</span>
          </div>
          <div class="scene-section-preview">
            <div class="entity-list">
              <div class="item-card" onclick="event.stopPropagation(); showView('item-rootstaff-detail')" style="cursor: pointer;">
                <div class="item-card-header">
                  <span class="item-card-name">Thornveil's Root-Staff</span>
                  <span class="item-type-label type-weapon">Weapon</span>
                </div>
                <div class="item-card-stat">1d8+2, Melee. Wickling ceremonial weapon, hums when near blighted growth.</div>
              </div>
              <div class="item-card">
                <div class="item-card-header">
                  <span class="item-card-name">Blightcrawler Antivenom</span>
                  <span class="item-type-label type-consumable">Consumable</span>
                </div>
                <div class="item-card-stat">Cures Poisoned condition. Brewed from the nest's own secretions.</div>
              </div>
              <div class="item-card">
                <div class="item-card-header">
                  <span class="item-card-name">Scout's Waymap</span>
                  <span class="item-type-label type-item">Item</span>
                </div>
                <div class="item-card-stat">Dace's hand-drawn map of routes through the overgrowth. Some waypoints are crossed out.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- WAVE 3: Synthesis (dimmed — not yet available) -->

        <!-- Transitions — dimmed, has detail card + read-aloud (clickable for review) -->
        <div class="scene-section collapsed wave3-inactive has-detail" data-section="transitions">
          <div class="scene-section-header" style="pointer-events: auto;">
            <span class="scene-section-chevron">&#9654;</span>
            <span class="scene-section-name" onclick="showView('transitions-detail')" style="cursor: pointer;">Transitions</span>
            <svg class="speaking-icon" onclick="showView('transitions-detail')" style="cursor: pointer;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <div class="scene-section-preview">
            <span class="scene-section-meta">Populates when sections above are complete</span>
          </div>
        </div>

        <!-- Portents — dimmed, has detail drill-in (clickable for review) -->
        <div class="scene-section collapsed wave3-inactive has-detail" data-section="portents">
          <div class="scene-section-header" style="pointer-events: auto;">
            <span class="scene-section-chevron">&#9654;</span>
            <span class="scene-section-name" onclick="showView('portents-detail')" style="cursor: pointer;">Portents</span>
          </div>
          <div class="scene-section-preview">
            <span class="scene-section-meta">Populates when sections above are complete</span>
          </div>
        </div>

        <!-- GM Notes — dimmed (clickable for review) -->
        <div class="scene-section collapsed wave3-inactive has-detail" data-section="gm-notes">
          <div class="scene-section-header" style="pointer-events: auto;">
            <span class="scene-section-chevron">&#9654;</span>
            <span class="scene-section-name" onclick="showView('gm-notes-detail')" style="cursor: pointer;">GM Notes</span>
          </div>
          <div class="scene-section-preview">
            <span class="scene-section-meta">Populates when sections above are complete</span>
          </div>
        </div>

      </div>

      <!-- ============================================================
           VIEW: Setup Detail Card
           ============================================================ -->
      <div class="panel-view" id="setup-detail">
        <div class="detail-card-header">
          <button class="back-btn" onclick="showView('accordion-view')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            Back to Scene
          </button>
          <div class="detail-card-title">Setup</div>
          <div class="detail-card-subtitle">Scene 2 — Wickling Hollow</div>
        </div>
        <div class="detail-card-body">
          <p>The trail narrows as the forest thickens, ancient withertrees towering overhead with bark like cracked iron. Bioluminescent moss pulses faintly along the roots — the only light beneath the canopy. Then the trees open, and the Hollow reveals itself: a settlement carved into the living trunks, connected by rope bridges and spiral staircases that wind up into the dark green above.</p>
          <p>Wickling sentries watch from elevated platforms, their carved masks impassive. The air smells of damp earth and something sharper — fungal growth, recent and aggressive, creeping along the lower walkways.</p>

          <div class="read-aloud">
            <div class="read-aloud-label">Read Aloud</div>
            <div class="read-aloud-text">
              The forest parts like a curtain, and you see it — a village that breathes. Enormous trees, wider than any tower you've known, rise from the earth with doors and windows carved into their living bark. Rope bridges sway between them, and somewhere above you, wind chimes made of bone and seed-pod sing a melody that sounds almost like a warning.<br><br>
              A figure descends a spiral staircase, unhurried. An elder Wickling, their face half-hidden behind a mask of woven roots. They stop three paces away, close enough to speak, far enough to run.<br><br>
              "Outsiders. We smelled you an hour ago." The mask tilts. "State your purpose, or the forest will state it for you."
            </div>
          </div>

          <p>Elder Thornveil's greeting is not hostile — but it's not warm either. She watches the party's reactions carefully. A Wickling behind her adjusts the grip on a thorn-tipped spear. The party has about thirty seconds of silence before Thornveil decides the conversation is over.</p>
        </div>
      </div>

      <!-- ============================================================
           VIEW: Developments Detail Card
           ============================================================ -->
      <div class="panel-view" id="developments-detail">
        <div class="detail-card-header">
          <button class="back-btn" onclick="showView('accordion-view')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            Back to Scene
          </button>
          <div class="detail-card-title">Developments</div>
          <div class="detail-card-subtitle">Scene 2 — Wickling Hollow</div>
        </div>
        <div class="detail-card-body">
          <p><strong>The Trade:</strong> Once the party has stated their purpose, Elder Thornveil takes them to the Hollow's central platform — a natural amphitheatre formed by three interlocking root systems. Here, she reveals the true state of things.</p>
          <p>A Blightcrawler nest has taken root beneath the Hollow's primary water source. The creatures are aggressive, venomous, and breeding fast. The Wicklings are too few and too old to clear the nest themselves. Thornveil offers a trade: purge the nest, and she'll share what the Wicklings know about the Reaping Eye's resting place.</p>

          <div class="read-aloud">
            <div class="read-aloud-label">Read Aloud</div>
            <div class="read-aloud-text">
              Thornveil leads you down, past the living quarters, past the stores, to where the roots drink deep. The air changes — wet and sour, thick with something that makes your eyes water. Through a lattice of exposed roots, you see it: a pulsing mass of chitin and silk, threaded through the root system like a disease.<br><br>
              "They came with the overgrowth," Thornveil says, her voice flat. "Three weeks. We've lost two scouts and our water tastes of venom. Help us cut this rot out, and I will tell you what the old trees told me about the Eye."
            </div>
          </div>

          <p><strong>The Complication:</strong> Before the party can decide, a Wickling guard brings word: the Havenite prisoner is asking to speak with the outsiders. Corporal Dace, wounded and under guard in a root-cage, has heard the party arrive.</p>
          <p>Dace claims to know a shortcut through the overgrowth to the Eye — a route his squad mapped before they were ambushed. No Wickling help needed. But Thornveil warns the party: Dace's squad burned Wickling farmland on their way through. His "shortcuts" have a cost.</p>
          <p><strong>The Three-Way Choice:</strong></p>
          <ul style="padding-left: 18px; margin: 8px 0;">
            <li style="margin-bottom: 6px;"><strong>Side with the Wicklings</strong> — Fight the Blightcrawler nest. Earns Thornveil's trust and the Wicklings' knowledge. Takes time; the overgrowth advances.</li>
            <li style="margin-bottom: 6px;"><strong>Trust Dace</strong> — Leave immediately with the shortcut. Faster, but burns the Wickling bridge and the route may have traps or ambushes Dace isn't revealing.</li>
            <li><strong>Negotiate a compromise</strong> — Convince Thornveil to release Dace to help fight the nest in exchange for his freedom. Hardest path, but unites both factions' knowledge. Requires strong social rolls.</li>
          </ul>

          <div class="read-aloud">
            <div class="read-aloud-label">Read Aloud</div>
            <div class="read-aloud-text">
              The soldier's voice is hoarse through the bars of the root-cage. "You don't need them. I've walked the deep paths — my squad mapped every mile before the green took them. I can get you to the Eye in two days. They'll have you crawling through nests and singing to trees for a week."<br><br>
              Thornveil's mask turns toward the cage. The bone chimes go silent. "He burned our fields, outsiders. Every word he speaks is ash."
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================================
           VIEW: NPC Detail Card — Elder Thornveil
           ============================================================ -->
      <div class="panel-view" id="npc-thornveil-detail">
        <div class="detail-card-header">
          <button class="back-btn" onclick="showView('accordion-view')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            Back to Scene
          </button>
        </div>
        <div class="npc-detail-header">
          <div class="npc-detail-identity">
            <div class="npc-detail-name">Elder Thornveil</div>
            <span class="entity-role-tag role-leader">Leader</span>
          </div>
        </div>
        <div class="detail-card-body" style="padding-top: 16px;">
          <div class="npc-field">
            <div class="npc-field-label">Description</div>
            <div class="npc-field-value">Tall and angular, with bark-like skin patterns that deepen with age. Wears a mask of woven roots that covers the upper half of her face — she never removes it in front of outsiders. Moves with deliberate, unhurried precision. Her hands are stained dark green from decades of root-speaking rituals.</div>
          </div>
          <div class="npc-field">
            <div class="npc-field-label">Backstory</div>
            <div class="npc-field-value">The last of the Wickling root-speakers — those who could hear the forest's will through the mycorrhizal network beneath the soil. When Haven's army cut through Fanewick, that connection went silent. Thornveil has been faking communion with the forest ever since, holding her people together through the authority of a gift she no longer possesses.</div>
          </div>
          <div class="npc-field">
            <div class="npc-field-label">Voice &amp; Mannerisms</div>
            <div class="npc-field-value">Measured and deliberate, like someone choosing each word the way you'd choose a step on a rotting bridge. Addresses everyone as "seedling" regardless of age or station. Pauses mid-sentence to listen to sounds only she seems to hear. Fidgets with a braid of dried moss at her belt.</div>
          </div>
          <div class="npc-field">
            <div class="npc-field-label">Motivation</div>
            <div class="npc-field-value">Restore the Wickling people's faith — even if the forest never speaks again. Will sacrifice personal honor to maintain the illusion of divine communion. Desperate for the party to solve the Blightcrawler problem because it proves the forest still sends help through outsiders.</div>
          </div>
          <div class="npc-field">
            <div class="npc-field-label">Secret</div>
            <div class="npc-field-value">Thornveil knows the Reaping Eye wasn't just stolen — it was <em>given</em>. The Great Owl Nikta let Haven take it as a test, and Thornveil is the only one who witnessed the exchange. Revealing this would shatter the Wicklings' righteous anger and their reason to fight.</div>
          </div>
        </div>
      </div>

      <!-- ============================================================
           VIEW: NPC Detail Card — Corporal Dace
           ============================================================ -->
      <div class="panel-view" id="npc-dace-detail">
        <div class="detail-card-header">
          <button class="back-btn" onclick="showView('accordion-view')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            Back to Scene
          </button>
        </div>
        <div class="npc-detail-header">
          <div class="npc-detail-identity">
            <div class="npc-detail-name">Corporal Dace</div>
            <span class="entity-role-tag role-scout">Scout</span>
          </div>
        </div>
        <div class="detail-card-body" style="padding-top: 16px;">
          <div class="npc-field">
            <div class="npc-field-label">Description</div>
            <div class="npc-field-value">Mid-twenties, lean and sun-darkened, with a scout's watchful eyes. One arm is splinted with Wickling-made materials — they healed him even as they imprisoned him. A faded Havenite insignia is stitched to his collar, half-torn. He sits in the root-cage with the patient stillness of someone who's been waiting for exactly this moment.</div>
          </div>
          <div class="npc-field">
            <div class="npc-field-label">Backstory</div>
            <div class="npc-field-value">Part of a Havenite recon squad sent to map routes through the overgrowth. His squad was ambushed by the Witherwild itself — vines and thorns that moved with purpose. Dace survived by playing dead. The Wicklings found him three days later, delirious and half-starved. He's been their prisoner for two weeks.</div>
          </div>
          <div class="npc-field">
            <div class="npc-field-label">Voice &amp; Mannerisms</div>
            <div class="npc-field-value">Clipped and practical, with a soldier's habit of cutting to the point. Speaks faster when lying. Taps his fingers against his splint when nervous — a tell he doesn't know he has. Refers to the Wicklings as "the locals" with forced neutrality.</div>
          </div>
          <div class="npc-field">
            <div class="npc-field-label">Motivation</div>
            <div class="npc-field-value">Escape the Hollow and return to his commanding officer with the map data. Genuinely believes the shortcut is viable, but hasn't mentioned that two of the mapped waypoints were overrun by the overgrowth since his squad passed through.</div>
          </div>
          <div class="npc-field">
            <div class="npc-field-label">Secret</div>
            <div class="npc-field-value">Dace's squad didn't just map routes — they set incendiary charges along the way, designed to burn corridors through the overgrowth for a larger Havenite force. If the party follows his "shortcut," they'll trigger the charges and accelerate the Witherwild's retaliatory growth across the entire region.</div>
          </div>
        </div>
      </div>

      <!-- ============================================================
           VIEW: Adversary Detail Card — Blightcrawler Alpha
           ============================================================ -->
      <div class="panel-view" id="adversary-alpha-detail">
        <div class="detail-card-header">
          <button class="back-btn" onclick="showView('accordion-view')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            Back to Scene
          </button>
          <div class="detail-card-title">Blightcrawler Alpha</div>
          <div style="display: flex; align-items: center; gap: 8px; margin-top: 6px;">
            <span class="adversary-type-badge type-bruiser">Bruiser</span>
            <span style="font-size: 12px; color: var(--text-muted);">Difficulty 12 &middot; Tier 2</span>
          </div>
        </div>
        <div class="detail-card-body">
          <p style="margin-bottom: 12px;">A massive centipede-like creature, three metres long, with chitin plates that shift from dark green to oily black. Its mandibles drip a paralytic venom, and it communicates with its brood through subsonic vibrations that make the roots tremble.</p>

          <div class="stat-block">
            <div class="stat-item">
              <span class="stat-label">HP</span>
              <span class="stat-value">18</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Stress</span>
              <span class="stat-value">6</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Attack</span>
              <span class="stat-value">+5</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Weapon</span>
              <span class="stat-value">Barbed Mandibles</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Range</span>
              <span class="stat-value">Melee</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Damage</span>
              <span class="stat-value">2d8+3</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Minor</span>
              <span class="stat-value">5</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Major</span>
              <span class="stat-value">10</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Severe</span>
              <span class="stat-value">15</span>
            </div>
          </div>

          <div class="adversary-section">
            <div class="adversary-section-label">Motives &amp; Tactics</div>
            <div class="adversary-section-text">Protect the brood at all costs. Attacks the most threatening-looking target first, then retreats into burrow tunnels to strike from unexpected angles. Uses subsonic calls to coordinate brood attacks on flanks while it engages the party's front line.</div>
          </div>

          <div class="adversary-section">
            <div class="adversary-section-label">Features</div>
            <div class="adversary-feature">
              <div class="adversary-feature-name">Burrowing Strike</div>
              <div class="adversary-feature-desc">Can disappear into the root system and emerge adjacent to any creature within 30 feet. On its next attack after burrowing, deals an additional d6 damage.</div>
            </div>
            <div class="adversary-feature">
              <div class="adversary-feature-name">Toxic Spit</div>
              <div class="adversary-feature-desc">Ranged (20 ft). Target must make a Difficulty 14 save or become Poisoned — disadvantage on all rolls until the end of their next turn. Can use this once per short rest.</div>
            </div>
            <div class="adversary-feature">
              <div class="adversary-feature-name">Brood Commander</div>
              <div class="adversary-feature-desc">While the Alpha is alive, all Blightcrawler Brood within 30 feet gain +1 to attack rolls and cannot be Frightened.</div>
            </div>
          </div>

        </div>
      </div>

      <!-- ============================================================
           VIEW: Item Detail Card — Thornveil's Root-Staff
           ============================================================ -->
      <div class="panel-view" id="item-rootstaff-detail">
        <div class="detail-card-header">
          <button class="back-btn" onclick="showView('accordion-view')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            Back to Scene
          </button>
          <div class="detail-card-title">Thornveil's Root-Staff</div>
          <div style="display: flex; align-items: center; gap: 8px; margin-top: 6px;">
            <span class="item-type-label type-weapon">Weapon</span>
            <span style="font-size: 12px; color: var(--text-muted);">Melee &middot; 1d8+2</span>
          </div>
        </div>
        <div class="detail-card-body">
          <p>A staff of living withertree root, still faintly warm to the touch. The bark spirals in tight whorls around a core that pulses with a dim green luminescence. Thornveil carried it for decades as both walking aid and symbol of her station as root-speaker.</p>

          <div class="npc-field" style="margin-top: 16px;">
            <div class="npc-field-label">Properties</div>
            <div class="npc-field-value">When within 30 feet of blighted growth, the staff hums at a low frequency and the green light intensifies — functioning as a reliable detector. On a critical hit, vines briefly entangle the target (Difficulty 12 save or lose 5 feet of movement next turn).</div>
          </div>
          <div class="npc-field">
            <div class="npc-field-label">Lore</div>
            <div class="npc-field-value">Thornveil will only part with the staff if the party earns her deep trust — clearing the Blightcrawler nest alone isn't enough. She needs to believe they'll use it to protect, not to conquer. If given freely, it signifies the Wicklings' full alliance.</div>
          </div>
        </div>
      </div>

      <!-- ============================================================
           VIEW: Transitions Detail Card (Wave 3 — review content)
           ============================================================ -->
      <div class="panel-view" id="transitions-detail" style="opacity: 0.4;">
        <div class="detail-card-header">
          <button class="back-btn" onclick="showView('accordion-view')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            Back to Scene
          </button>
          <div class="detail-card-title">Transitions</div>
          <div class="detail-card-subtitle">Scene 2 — Wickling Hollow</div>
          <div style="margin-top: 8px; padding: 6px 10px; background: var(--bg-surface); border: 1px solid var(--border-medium); border-radius: var(--radius-sm); font-size: 11px; color: var(--text-muted); font-style: italic;">Text displayed in inactive section for review purposes only</div>
        </div>
        <div class="detail-card-body">
          <p><strong>If the party sided with the Wicklings:</strong> Thornveil leads them to the Hollow's eastern edge, where the canopy opens onto a narrow ridge. She points toward a column of sickly green light on the horizon. "The Eye rests where the rot began. Follow the dead trees — they'll point the way." She presses a carved root-token into the party leader's hand. "Show this to any Wickling you meet. They'll know you're friends of the Hollow."</p>

          <div class="read-aloud">
            <div class="read-aloud-label">Read Aloud</div>
            <div class="read-aloud-text">
              The ridge falls away beneath you, and for the first time since entering the Witherwild, you can see the sky. It's wrong — tinged green, like looking through stained glass. In the distance, a pillar of light rises from the forest floor, pulsing slowly, like a heartbeat.<br><br>
              Thornveil stands beside you, her mask turned toward the light. "That is where it sleeps. The Eye. Whatever you find there — remember that the forest is watching. It always watches."
            </div>
          </div>

          <p><strong>If the party trusted Dace:</strong> Dace leads them through a root-tunnel beneath the Hollow's walls, bypassing the sentries. The passage is tight and smells of char — the remnants of his squad's incendiary work. He moves fast, checking a hand-drawn map by torchlight. "Two days. Maybe less if we don't stop." The tunnel opens onto an overgrown game trail, and the sounds of the Hollow fade behind them.</p>

          <p><strong>If the party negotiated a compromise:</strong> The unlikely alliance departs together — Thornveil's knowledge of the forest paired with Dace's mapped routes. The tension between them is palpable, but both recognize the party as the bridge holding the arrangement together. Thornveil walks ahead, listening to the trees. Dace walks behind, checking his map. Neither speaks to the other.</p>
        </div>
      </div>

      <!-- ============================================================
           VIEW: Portents Detail Card (Wave 3 — echo categories drill-in)
           Absorbed from Scrying stage. Shows 5 echo categories with
           trigger/benefit/complication entries per category.
           ============================================================ -->
      <div class="panel-view" id="portents-detail" style="opacity: 0.4;">
        <div class="detail-card-header">
          <button class="back-btn" onclick="showView('accordion-view')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            Back to Scene
          </button>
          <div class="detail-card-title">Portents</div>
          <div class="detail-card-subtitle">Scene 2 — Wickling Hollow</div>
          <div style="margin-top: 8px; padding: 6px 10px; background: var(--bg-surface); border: 1px solid var(--border-medium); border-radius: var(--radius-sm); font-size: 11px; color: var(--text-muted); font-style: italic;">Text displayed in inactive section for review purposes only</div>
        </div>
        <div class="detail-card-body">

          <!-- Category 1: Items & Clues — EXPANDED -->
          <div class="echo-category expanded">
            <button class="echo-category-header" onclick="toggleCategory(this.parentElement)">
              <span class="echo-category-chevron">&#x25B8;</span>
              <span class="echo-category-name">Items &amp; Clues</span>
              <span class="echo-category-count">2</span>
            </button>
            <div class="echo-category-content">
              <div class="echo-entry">
                <div class="echo-title">Thornveil's Pressed Flower</div>
                <div class="echo-field">
                  <span class="echo-field-label trigger">Trigger:</span>
                  <span class="echo-field-text">A player examines Thornveil's staff or asks about the dried flower woven into it</span>
                </div>
                <div class="echo-field">
                  <span class="echo-field-label benefit">Benefit:</span>
                  <span class="echo-field-text">The flower is from before the overgrowth — Thornveil will share that the forest wasn't always hostile, hinting at the Eye's original purpose</span>
                </div>
                <div class="echo-field">
                  <span class="echo-field-label complication">Complication:</span>
                  <span class="echo-field-text">The flower crumbles at touch, and Thornveil's grief makes her less willing to cooperate for the rest of the scene</span>
                </div>
              </div>
              <div class="echo-entry">
                <div class="echo-title">Dace's Incendiary Charges</div>
                <div class="echo-field">
                  <span class="echo-field-label trigger">Trigger:</span>
                  <span class="echo-field-text">A player searches Dace's confiscated pack or succeeds on a Finesse check while near it</span>
                </div>
                <div class="echo-field">
                  <span class="echo-field-label benefit">Benefit:</span>
                  <span class="echo-field-text">Discover three small charges — proof that Dace's mission is destructive, not diplomatic</span>
                </div>
                <div class="echo-field">
                  <span class="echo-field-label complication">Complication:</span>
                  <span class="echo-field-text">Dace claims they're defensive, and the party must decide whether to believe him or confront him in front of the Wicklings</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Category 2: Environmental Shifts — COLLAPSED -->
          <div class="echo-category">
            <button class="echo-category-header" onclick="toggleCategory(this.parentElement)">
              <span class="echo-category-chevron">&#x25B8;</span>
              <span class="echo-category-name">Environmental Shifts</span>
              <span class="echo-category-count">1</span>
            </button>
            <div class="echo-category-content">
              <div class="echo-entry">
                <div class="echo-title">The Hollow Listens</div>
                <div class="echo-field">
                  <span class="echo-field-label trigger">Trigger:</span>
                  <span class="echo-field-text">The party raises their voice in argument or threatens violence within the Hollow</span>
                </div>
                <div class="echo-field">
                  <span class="echo-field-label benefit">Benefit:</span>
                  <span class="echo-field-text">The overgrowth constricts around the edges of the clearing — a visceral reminder that the forest responds to conflict</span>
                </div>
                <div class="echo-field">
                  <span class="echo-field-label complication">Complication:</span>
                  <span class="echo-field-text">If ignored, the constriction blocks the exit the party entered through, forcing them to negotiate a new path out</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Category 3: Social Openings — COLLAPSED -->
          <div class="echo-category">
            <button class="echo-category-header" onclick="toggleCategory(this.parentElement)">
              <span class="echo-category-chevron">&#x25B8;</span>
              <span class="echo-category-name">Social Openings</span>
              <span class="echo-category-count">1</span>
            </button>
            <div class="echo-category-content">
              <div class="echo-entry">
                <div class="echo-title">The Elder's Test</div>
                <div class="echo-field">
                  <span class="echo-field-label trigger">Trigger:</span>
                  <span class="echo-field-text">A player asks Thornveil a direct question about the Eye without diplomatic preamble</span>
                </div>
                <div class="echo-field">
                  <span class="echo-field-label benefit">Benefit:</span>
                  <span class="echo-field-text">Thornveil respects directness — she reveals the location of the Eye faster than through formal negotiation</span>
                </div>
                <div class="echo-field">
                  <span class="echo-field-label complication">Complication:</span>
                  <span class="echo-field-text">Other Wicklings see this as disrespect and become hostile, splitting the village's support</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Category 4: Magical Effects — COLLAPSED -->
          <div class="echo-category">
            <button class="echo-category-header" onclick="toggleCategory(this.parentElement)">
              <span class="echo-category-chevron">&#x25B8;</span>
              <span class="echo-category-name">Magical Effects</span>
              <span class="echo-category-count">1</span>
            </button>
            <div class="echo-category-content">
              <div class="echo-entry">
                <div class="echo-title">Root Memory</div>
                <div class="echo-field">
                  <span class="echo-field-label trigger">Trigger:</span>
                  <span class="echo-field-text">A spellcaster touches the central tree in Wickling Hollow and channels any divination magic</span>
                </div>
                <div class="echo-field">
                  <span class="echo-field-label benefit">Benefit:</span>
                  <span class="echo-field-text">A flash of the tree's memory — they see Thornveil receiving the Eye willingly from a Havenite emissary decades ago</span>
                </div>
                <div class="echo-field">
                  <span class="echo-field-label complication">Complication:</span>
                  <span class="echo-field-text">The vision is painful and public — every Wickling in the clearing sees it too, and Thornveil's secret is exposed</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Category 5: Future Threads — COLLAPSED -->
          <div class="echo-category">
            <button class="echo-category-header" onclick="toggleCategory(this.parentElement)">
              <span class="echo-category-chevron">&#x25B8;</span>
              <span class="echo-category-name">Future Threads</span>
              <span class="echo-category-count">1</span>
            </button>
            <div class="echo-category-content">
              <div class="echo-entry">
                <div class="echo-title">The Hollow's Invitation</div>
                <div class="echo-field">
                  <span class="echo-field-label trigger">Trigger:</span>
                  <span class="echo-field-text">A player expresses genuine admiration for the Wickling way of life or offers to help without conditions</span>
                </div>
                <div class="echo-field">
                  <span class="echo-field-label benefit">Benefit:</span>
                  <span class="echo-field-text">Thornveil marks them as "root-friend" — a status that could grant sanctuary in future adventures set in the Witherwild</span>
                </div>
                <div class="echo-field">
                  <span class="echo-field-label complication">Complication:</span>
                  <span class="echo-field-text">The mark is literal — a faint vine pattern appears on their skin, and outsiders may mistake them for Wickling agents</span>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- ============================================================
           VIEW: GM Notes Detail Card (Wave 3 — review content)
           ============================================================ -->
      <div class="panel-view" id="gm-notes-detail" style="opacity: 0.4;">
        <div class="detail-card-header">
          <button class="back-btn" onclick="showView('accordion-view')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            Back to Scene
          </button>
          <div class="detail-card-title">GM Notes</div>
          <div class="detail-card-subtitle">Scene 2 — Wickling Hollow</div>
          <div style="margin-top: 8px; padding: 6px 10px; background: var(--bg-surface); border: 1px solid var(--border-medium); border-radius: var(--radius-sm); font-size: 11px; color: var(--text-muted); font-style: italic;">Text displayed in inactive section for review purposes only</div>
        </div>
        <div class="detail-card-body">
          <div class="npc-field">
            <div class="npc-field-label">Pacing</div>
            <div class="npc-field-value">This is the social/exploration heart of the adventure. Let the negotiation breathe — don't rush to the Blightcrawler fight. The three-way choice is the scene's climax, not the combat. If players try to skip negotiation entirely, have Thornveil refuse to speak until they've shown respect (a short skill challenge).</div>
          </div>
          <div class="npc-field">
            <div class="npc-field-label">Improvisation Hooks</div>
            <div class="npc-field-value">If the party splits (some help Wicklings, some talk to Dace), run parallel scenes — cut between them to build tension. If they try to free Dace by force, the Wickling sentries intervene and the scene shifts to a tense standoff. If they ignore both options and try to leave, the overgrowth blocks the obvious exits — the forest is funneling them toward the choice.</div>
          </div>
          <div class="npc-field">
            <div class="npc-field-label">Consequences That Carry</div>
            <div class="npc-field-value">The choice here ripples through Scenes 3 and 4. Siding with the Wicklings earns allies but costs time — the overgrowth advances, making Scene 3 harder. Trusting Dace is faster but triggers the incendiary charges in Scene 3, with environmental consequences in Scene 4. The compromise path is the hardest to earn but provides the most resources for the finale.</div>
          </div>
          <div class="npc-field">
            <div class="npc-field-label">Thornveil's Secret</div>
            <div class="npc-field-value">Thornveil's knowledge that the Eye was given (not stolen) is a bombshell best saved for Scene 3 or 4, but a high Insight check during negotiation might catch her hesitation. Don't reveal it outright — plant doubt. "She pauses too long before answering. Something about the way she says 'stolen' doesn't sit right."</div>
          </div>
        </div>
      </div>

      <!-- Fixed Footer — always visible at bottom of panel -->
      <div class="panel-footer">
        <button class="btn-continue-compact" id="btn-confirm-scene" disabled>Confirm Scene</button>
      </div>

    </div>

    </div><!-- /app-layout -->
  </div><!-- /app-shell -->

  <script>
    /* === View Navigation ===
       Multiple panel views share the same flex slot. Only one is visible.
       Mirrors Binding's gallery↔detail cross-fade pattern.
    */
    function showView(viewId) {
      document.querySelectorAll('.panel-view').forEach(v => v.classList.remove('active'));
      const target = document.getElementById(viewId);
      if (target) {
        target.classList.add('active');
        target.scrollTop = 0;
      }
    }

    /* === Section Accordion ===
       Chevron click toggles expand/collapse. Entity cards and detail card
       links live inside the expanded preview content.
    */
    function toggleSection(headerOrChevron) {
      const header = headerOrChevron.closest('.scene-section-header');
      const section = header.closest('.scene-section');
      // Don't toggle Wave 3 inactive sections
      if (section.classList.contains('wave3-inactive')) return;
      section.classList.toggle('collapsed');
    }

    /* === Echo Category Accordion (Portents) === */
    function toggleCategory(category) {
      category.classList.toggle('expanded');
    }

    /* === Phase Dropdown === */
    function togglePhaseDropdown() {
      const dropdown = document.getElementById('phase-dropdown');
      const chevron = document.getElementById('phase-chevron');
      const trigger = document.querySelector('.app-header-phase');
      const isOpen = dropdown.classList.contains('open');
      if (isOpen) {
        dropdown.classList.remove('open'); chevron.classList.remove('open');
        trigger.setAttribute('aria-expanded', 'false');
      } else {
        dropdown.classList.add('open'); chevron.classList.add('open');
        trigger.setAttribute('aria-expanded', 'true');
      }
    }

    document.addEventListener('click', function(e) {
      const trigger = document.querySelector('.app-header-phase');
      const dropdown = document.getElementById('phase-dropdown');
      if (!trigger.contains(e.target)) {
        dropdown.classList.remove('open');
        document.getElementById('phase-chevron').classList.remove('open');
        trigger.setAttribute('aria-expanded', 'false');
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const dropdown = document.getElementById('phase-dropdown');
        if (dropdown.classList.contains('open')) {
          dropdown.classList.remove('open');
          document.getElementById('phase-chevron').classList.remove('open');
          document.querySelector('.app-header-phase').setAttribute('aria-expanded', 'false');
        }
      }
    });

    /* === Textarea Auto-resize === */
    const textarea = document.querySelector('.chat-input');
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 180) + 'px';
    });

    /* === Scroll chat to bottom === */
    document.querySelector('.message-area').scrollTop = document.querySelector('.message-area').scrollHeight;
  </script>

</body>
</html>